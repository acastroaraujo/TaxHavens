---
title: "Network Explorer"
author: "Andrés Castro Araújo"
date: "3/14/2019"
output: 
  html_document:
    code_folding: hide
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.align = "center")
```

This notebook goes over the steps necessary to create **THIS** Shiny app.

```{r}
library(tidyverse)
library(countrycode)
library(geonames)

source_info <- read_csv("source_info.csv")
target_info <- read_csv("target_info.csv")
gdp <- readRDS("wdi_data/wdi_data.RDS") %>% 
  select(country, continent, year, NY.GDP.MKTP.CD) %>%
  rename(gdp = NY.GDP.MKTP.CD) %>% 
  ungroup()

target_info <- target_info %>%
  left_join(rename(gdp, target = country)) %>% 
  rename(target_gdp = gdp, target_continent = continent) %>% 
  drop_na() %>% 
  left_join(rename(gdp, source = country)) %>% 
  rename(source_gdp = gdp, source_continent = continent) %>% 
  drop_na()

source_info <- source_info %>%
  left_join(rename(gdp, target = country)) %>% 
  rename(target_gdp = gdp, target_continent = continent) %>% 
  drop_na() %>% 
  left_join(rename(gdp, source = country)) %>% 
  rename(source_gdp = gdp, source_continent = continent) %>% 
  drop_na()
```

**Get "sizes" for each country and year**

```{r}
source_info_sizes <- source_info %>% 
  mutate(ff = flow * 1e6 / target_gdp) %>% 
  group_by(target, year) %>% 
  summarise(size = sum(ff)) %>% 
  arrange(-size)

target_info_sizes <- target_info %>% 
  mutate(ff = flow * 1e6 / target_gdp) %>% 
  group_by(target, year) %>% 
  summarise(size = sum(ff)) %>% 
  arrange(-size)
```

**Get world map**

```{r}
library(maps)
library(mapproj)
world_data <- map_data("world") %>% 
  filter(region != "Antartica") %>% 
  mutate(iso = maps::iso.alpha(region, n = 3))

  

theme_map <- theme_void(base_family = "Palatino") + 
  theme(plot.background = element_rect(fill = "antiquewhite"))

mapcoords <- coord_fixed(xlim = c(-170, 180), ylim = c(-55, 80))

country_shapes <- geom_polygon(aes(x = long, y = lat, group = group),
                               data = world_data,
                               fill = "steelblue1", color = "grey",
                               size = 0.05) 

g <- ggplot(NULL) + country_shapes + theme_map + mapcoords
g
```

**Get country longitudes and latitudes**

```{r}
source("google_key_api.R")
library(ggmap)
register_google(key)

COL <- geocode("Colombia")
COL

g + geom_point(data = COL, aes(x = lon, y = lat), color = "red")
```

```{r, eval = FALSE}
library(igraph)
Gt <- graph_from_data_frame(target_info)
nodes <- tibble(name = V(Gt)$name)

nodes <- nodes %>% 
  mutate(iso = countrycode::countrycode(
    name, 
    origin = "country.name", 
    destination = "iso3c")
    )

nodes <- nodes %>% 
  mutate(coords = purrr::map(paste(name, "country"), geocode))

nodes <- nodes %>% 
  unnest(coords)

write_delim(nodes, "nodes.txt")
```

```{r}
node_info <- read_delim("nodes.txt", delim = " ")
```

```{r}
g + geom_point(data = node_info, aes(x = lon, y = lat), size = 0.5)
```

**Note**. *Some of these might be wrong (Google can make mistakes)!*

```{r}
library(ggraph)
library(igraph)
library(tidygraph)

make_flows <- function(t = "Colombia", y = 2012) {
  theme_map <- theme_void(base_family = "Palatino") + 
    theme(plot.background = element_rect(fill = "antiquewhite"))

  Gt <- graph_from_data_frame(
    target_info %>% 
      filter(target == t, year == y)
    ) %>% 
    as_tbl_graph() %>% 
    activate(edges) %>% 
    filter(flow != 0) %>% 
    mutate(type = ifelse(flow < 0, "negative", "positive"),
           edge_weight = abs(flow) * 1e5 / target_gdp
           ) %>% 
    activate(nodes) %>% 
    left_join(node_info) %>% 
    left_join(target_info_sizes %>%
                filter(year == y),
              by = c("name" = "target")) %>% 
    rename(node_size = size)
  
  lay <- create_layout(
    graph = Gt, 
    layout = "manual",
    node.positions = rename(
      as_data_frame(Gt, what = "vertices"), 
      x = lon, y = lat)
    )
  
  country_shapes <- geom_polygon(
    aes(x = long, y = lat, group = group, fill = active),
    data = world_data <- world_data %>% 
    mutate(active = ifelse(iso %in% V(Gt)$iso, TRUE, FALSE)),
    color = "grey",
    size = 0.05,
    show.legend = FALSE)
  
  g <- ggraph(lay) + 
    country_shapes +
    geom_edge_arc(aes(color = type, alpha = edge_weight), 
                  curvature = 1/3, show.legend = FALSE,
                  arrow = arrow(length = unit(0.1, "cm")),
                  end_cap = circle(0.1, "cm"),
                  start_cap = circle(0.1, "cm"),
                  width = 0.8) +
    theme_map + mapcoords +
    scale_edge_color_manual(values = c("red", "forestgreen")) +
    scale_fill_manual(values = c("white", "grey")) +
    labs(caption = paste0("Foreign Direct Investment to ", t, ", ", y))
  
  return(g)
}



    
make_flows(t = "Colombia", 2005)
make_flows(t = "Panama", 2008)
make_flows(t = "Bahamas", 2008)
```



